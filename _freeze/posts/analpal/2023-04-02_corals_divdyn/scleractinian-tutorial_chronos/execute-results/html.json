{
  "hash": "a1809074e351e803f9474fe4a15825b6",
  "result": {
    "markdown": "---\ntitle: 'Basic diversity dynamics of scleractinian corals with divDyn'\nsubtitle: 'A basic introduction to the divDyn package'\nresource-path: ['../../../']\nbibliography: 'bibliography/evolved.bib'\nsummary: A basic introduction to the divDyn package\ntoc: true\nauthor:\n  - name: Kocsis, Adam \n    url: \"../../../adam_kocsis.html\" \ncategories:\n  - divDyn\n  - PBDB\n---\n\n\n\n\n# Goals and introduction\n\nThe purpose of this vignette is to guide new users through data acquisition and analysis, as well as to demonstrate the basic capabilities of the divDyn R [@kocsis2019package] package. This tutorial will use Scleractininan corals as an example group which was selected selected because the due to data quality reasons and as we have readily available additional information about the coral taxa with which to customize the analyses. \n\n\n# Occurrence data download\nTo run analyses, first the occurrence data have to be downloaded and processed. \nYou can download all PBDB occurrences using the ``chronosphere`` R package. The ``chronosphere`` is an initiative we have started at GeoZentrum Nordbayern in Erlangen, to facilitate the use, tracability, portability and version controlling of data in scientific analyses.\n\nThe package is available from the CRAN repositories and can be installed with the following line of code (you will probably have to select your preferred download mirror).\n\n\n::: {.cell}\n\n```{.r .cell-code}\ninstall.packages(\"chronosphere\")\n```\n:::\n\n\nAfter the package is installed, it is ready for use, you can attach it with:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(chronosphere)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nLoading required package: raster\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nLoading required package: sp\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndat <- fetch(\"pbdb\", ver=\"20220510\")\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nIf you use the data in publications, please cite its\nreference(s), as well as that of the 'chronosphere' package.\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nPlease remember to acknowledge the Paleobiology Database (http://paleobiodb.org) in your publication.\n```\n:::\n:::\n\n\nThis is a pre-processed version of the PBDB that was downloaded with this API call:\n\n::: {.cell}\n\n```{.r .cell-code}\nattributes(dat)$chronosphere$API\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"https://paleobiodb.org/data1.2/occs/list.csv?datainfo&rowcount&interval=Ediacaran,Holocene&show=class,classext,genus,subgenus,coll,coords,loc,paleoloc,strat,stratext,lith,env,ref,crmod,timebins,timecompare,refattr,entname,attr,ident,img,plant,abund,ecospace,taphonomy,etbasis,pres,prot,lithext,geo,methods,resgroup,refattr,ent\"\n```\n:::\n:::\n\n\nYou can copy and paste this URL to your browser and the PBDB would compile the current corresponding dataset for you. \nIt normally takes about 15-30 minutes to get the dataset, another couple of minutes to download the .csv, which you still have to read in using ``read.table()``.\n\nThe PBDB API allows much more flexible download, but this denormalized version of the PBDB is enough for the overwhelming majority of the analyses.\nThere are some cases, when the data you are interested in are not in this subset and you have to use the API yourself.\n\n# Data processing\n\n## Installing and loading divDyn\n\nTo process the stratigraphic information in the downloaded occurrence file, and do the analyses, you have to to install and attach the divDyn package.\n\nThe package is available from the CRAN repositories and can be installed with the following line of code (you will probably have to select your preferred download mirror).\n\n\n::: {.cell}\n\n```{.r .cell-code}\ninstall.packages(\"divDyn\")\n```\n:::\n\n\nAfter the package is installed, it is ready for use, you can attach it with:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(divDyn)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nv0.8.2. See latest changes with 'news(package=\"divDyn\")'. Default: \nTime flows forward with 'bin', and backward with 'age' and 'slice()'.\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n\nAttaching package: 'divDyn'\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nThe following object is masked from 'package:chronosphere':\n\n    matchtime\n```\n:::\n:::\n\n\n\n## Initial filtering\n\nThe downloaded dataset needs to be subsetted to represent the order of scleractinian corals. \n\n::: {.cell}\n\n```{.r .cell-code}\ndat <- dat[dat$order==\"Scleractinia\",]\n```\n:::\n\n\nThe analyses will be conducted at the level of genera. \n\nThe entries that have no valid genus names in the PaleoDB can be omitted at this stage. They will not provide us any information about the evolution of the group.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# omit non-genus entries\ndat<- dat[!dat$genus==\"\", ]\n```\n:::\n\n\nThe dataset should be cleaned as much as possible at this stage, for didactic purposes and for keeping things simple, this step is skipped in this tutorial.\n\n\n## Stratigraphic resolution\n\nEvery colleciton in the the PaleoDB has a user entered ``'early_interval'`` and ``'late_interval'`` field. These are fields are used to place the collection in stratigraphy/geological time. The ``'early_interval'`` collection is mandatory for every entry while the ``'late_interval'`` is only necessary if the taxon does not fit in the interval specified as ``'early_interval'``. Otherwise the ``'late_interval'`` field is blank (empty quotes: ``\"\"``).\n\nThe divDyn package uses two frequently used, discrete time scales that we use as the finest stratiigraphic resolution of our analyses: the stage level time scale (``stages``, 95 bins) and the ten million year time scale (``tens``, 49 bins). These can be attached with the ``data()`` function:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata(stages)\ndata(tens)\n```\n:::\n\n\nThese will be useful for plotting as they contain the age estimates for the intervals, but they are not too useful for finding which interval the ``'early_interval'`` and ``'late_interval'`` fields point to. This can be found in the ``keys`` object.\n\t\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata(keys)\n```\n:::\n\n\nThis list is designed to be used with the ``categorize()`` function of the package, that combines the large number of entries to and replaces them with the name of the group they belong to. This has to be run on both the ``'early_interval'`` and the ``'late_interval'`` fields.\n\t\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# the 'stg' entries (lookup)\nstgMin <- categorize(dat[ ,\"early_interval\"], keys$stgInt)\nstgMax <- categorize(dat[ ,\"late_interval\"], keys$stgInt)\n```\n:::\n\n\nThe output of this function is either an interval number that corresponds to the ``stages`` timescale, ``-1``, indicating that the value was empty quotes, or ``NA``, if the interval is either not in the lookup table or is too broad. \n\t\nBecause this scheme is designed for general use, the output of this function is a vector of character values. These have to be demoted to numeric values, otherwise their order would not be correct.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# convert to numeric\n  stgMin <- as.numeric(stgMin)\n  stgMax <- as.numeric(stgMax)\n```\n:::\n\n\t\nNow these two vectors have to be combined. There are more solutions to solve the problem of stratigraphic uncertainty, but for the sake of simplicity, let's just omit every occurrence that cannot be assigned to a single stage in the ``stages`` timescale. For that, we will create an empty container, check whether an the interval entry for the occurrence satisfies the condition above, and if so, save the interval ID.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# empty container\ndat$stg <- rep(NA, nrow(dat))\n\n# select entries, where\nstgCondition <- c(\n# the early and late interval fields indicate the same stg\n  which(stgMax==stgMin),\n# or the late_intervar field is empty\n  which(stgMax==-1))\n\n# in these entries, use the stg indicated by the early_interval\n  dat$stg[stgCondition] <- stgMin[stgCondition]\t\n```\n:::\n\n\nNow every occurrence entry either has a single integer number in the ``stg`` column, or ``NA`` as its interval identifier. Note that the code above cannot be used for Cambrian and Ordovician occurrences due to stratigraphic problems. If you are interested in assigning these to stage-level intervals, we recommend to take a look at the vignette we wrote that describes global marine, Phanerozoic scale analyses:\n```\nhttps://github.com/divDyn/ddPhanero/blob/master/doc/1.0.1/dd_phanero.pdf\n```\n\nThe assignments can be repeated for the 10-million year bins with the following commands:\n\n::: {.cell}\n\n```{.r .cell-code}\n# a. categorize interval names to bin numbers\n  # categorize is the new function of the package\n  binMin<-categorize(dat[,\"early_interval\"],keys$binInt)\n  binMax<-categorize(dat[,\"late_interval\"],keys$binInt)\n  # convert to numeric\n  binMin<-as.numeric(binMin)\n  binMax<-as.numeric(binMax)\n# b. resolve max-min interval uncertainty\n# final variable (empty)\n  dat$bin <- rep(NA, nrow(dat))\n# use entries, where\n  binCondition <- c(\n  # the early and late interval fields indicate the same bin\n  \twhich(binMax==binMin),\n  # or the late_interval field is empty\n  \twhich(binMax==-1))\n# in these entries, use the bin indicated by the early_interval\n  dat$bin[binCondition] <- binMin[binCondition]\n```\n:::\n\n\n# Sampling assessment\n\nYou can assess how well the stratigraphic resolution turned out by running the ``table()`` function on the interval-identifier vector:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntable(dat$stg)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n  49   54   55   56   57   58   59   60   61   62   63   64   65   66   67   68 \n   5  114   72  446  910  600  101   86  220   80   87  491  383  231 1953 1149 \n  69   70   71   72   73   74   75   76   77   78   79   80   81   82   83   84 \n 988  157  288  207  483 1025  389  529  124   71  158  294  745  377  311  235 \n  85   86   87   88   89   90   91   92   93   94   95 \n 225  458  656  519 1127 1818 1184 1463 1903 7825 1201 \n```\n:::\n:::\n\n\nSumming it tells us how many of the overall occurrences we can assign to stratigraphic stages.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsum(table(dat$stg))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 31688\n```\n:::\n\n```{.r .cell-code}\n# which is a\nsum(table(dat$stg))/nrow(dat)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 0.8528826\n```\n:::\n\n```{.r .cell-code}\n# proportion of the total data.\n```\n:::\n\n\nAs we cannot use unresolved occurrences in any way, coding will be easier if we omit them at this stage.  \n\n\n::: {.cell}\n\n```{.r .cell-code}\n# omit unbinned\ndats <- dat[!is.na(dat$stg),]\n```\n:::\n\n\nIf you take a look at the stage object, you can notice that besides the few entries in stages ``37``, ``49`` and ``50``, Scleractinian become important fossils in the Anisian stage. \n\n\n::: {.cell}\n\n```{.r .cell-code}\n# omit Paleozoic\ndats <- dats[dats$stg>52,]\n```\n:::\n\n\nYou can get a more organized view of sampling parameters by running the ``binstat()`` function in divDyn, that calculates the occurrence, collection, and reference counts in a single line. This is the general use of the high-level function of the package: you state the occurrence ``data.frame`` as the first, and then the column names as additional arguments. The column ``tax`` stands for the taxon names, ``bin`` for the discrete time bins, ``coll`` for collection identifiers and ``ref`` for reference identifiers.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbsFull <- binstat(dats, tax=\"genus\", bin=\"stg\", \n  coll=\"collection_no\", ref=\"reference_no\")\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nThe database contains duplicate occurrences (multiple species/genus).\n```\n:::\n\n```{.r .cell-code}\nbsFull$occs\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n [1]   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA\n[16]   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA\n[31]   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA\n[46]   NA   NA   NA   NA   NA   NA   NA   NA  114   72  446  910  600  101   86\n[61]  220   80   87  491  383  231 1953 1149  988  157  288  207  483 1025  389\n[76]  529  124   71  158  294  745  377  311  235  225  458  656  519 1127 1818\n[91] 1184 1463 1903 7825 1201\n```\n:::\n:::\n\n\nThis output is organizes so that the index of the values in the vector match up the bin identifier (e.g. 60th value is for stg ``60``).\nThe default setting of the function will output a message about duplicate occurrences. This warns us that there are collections with more than one genus entries in a collection (i.e. more than one species/genus). If you are interested in genus-level analyses, it is probably better to count these as one, which you can do with ``duplicates=FALSE`` option.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbs <- binstat(dats, tax=\"genus\", bin=\"stg\", \n  coll=\"collection_no\", ref=\"reference_no\", duplicates=FALSE)\nbs$occs\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n [1]   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA\n[16]   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA\n[31]   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA\n[46]   NA   NA   NA   NA   NA   NA   NA   NA   99   66  355  769  442   77   72\n[61]  201   77   74  411  291  206 1663  906  701  126  243  190  387  824  348\n[76]  448  115   63  146  224  632  341  271  217  192  407  508  410  908 1207\n[91]  954 1117 1474 6154  972\n```\n:::\n:::\n\n\n## Plotting\n\nPlotting these variables is probably better then just looking at the numbers. The package includes a powerful time-scale plotting function that lets you visualize the how time is broken down to discrete intervals. This highly-customizable function is built on the basic ``plot()`` function, and most of its arguments are inherited. The following function call will draw plot with in the past 250 million years, with series-level shading and system-level boxes at the bottom:\n\n\n::: {.cell plot='true'}\n\n```{.r .cell-code}\ntsplot(stages, boxes=\"sys\", boxes.col=\"systemCol\", \n\tshading=\"series\", xlim=c(250, 0), ylim=c(0,2000))\n```\n\n::: {.cell-output-display}\n![](scleractinian-tutorial_chronos_files/figure-html/basePlot-1.png){width=672}\n:::\n:::\n\n\nThe you can draw the number of occurrences with ``lines()``. As the same row indices in the stages object and the result of ``binstat()`` indicate values that belong to the same interval, you do not need any subsetting to align the to data.frames. \n\n\n::: {.cell plot='true'}\n\n```{.r .cell-code}\ntsplot(stages, boxes=\"sys\", boxes.col=\"systemCol\", \n  shading=\"series\", xlim=c(250, 0), ylim=c(0,2000), ylab=\"Number occurrences\")\nlines(stages$mid, bs$occs)\n```\n\n::: {.cell-output-display}\n![](scleractinian-tutorial_chronos_files/figure-html/basePlotLine-1.png){width=672}\n:::\n:::\n\n\nWe will mostly use the same basic function call for plotting, and typing all these arguments is time consuming. But we can spare some time, if we defined a wrapper function around the plotting that executes the plotting call the with the same arguments that we want to keep the same, while allowing us to change what we would like to change. This is fairly straightforward with the ``...`` argument that allows you to pass arguments through function calls.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntp <- function(...)\ttsplot(stages, boxes=\"sys\", boxes.col=\"systemCol\", \n  shading=\"series\", xlim=52:95, ...)\n```\n:::\n\n\nNow, every time you call the newly defined function ``tp()`` it will have the same colour, shading and x-interval, while you can change other arguments of the ``tsplot()`` function. For instance if you wanted see how the number of collections change over time, you can draw a similar plot as above, with:\n\n\n::: {.cell plot='true'}\n\n```{.r .cell-code}\ntp(ylim=c(0,350), ylab=\"Number of collections\")\t\n  lines(stages$mid, bs$colls)\n```\n\n::: {.cell-output-display}\n![](scleractinian-tutorial_chronos_files/figure-html/collPlot-1.png){width=672}\n:::\n:::\n\n\nThe nicest feature of this function is that you do not have to use the built-in data, you can create your own timescale, as long as you use the same structure as in stages and specify the top and bottom boundaries of the intervals (top and bottom columns). \n\nIt is not surprising that occurrences and collection numbers have the same overall trajectory. As you can see, the sampling of corals is highly volatile over time, with a couple of marked peaks in the late Triassic, Late Jurassic, mid and Late Creteacoues and the Neogene, that we have to take into consideration in some form, when describing the evolution of the group.\n\n\n# Richness through time\n\nNow that we know how sampling changed over time, we can calculate a lot of diversity, extinction and origination rate series from the dataset with the basic ``divDyn()`` function. This function requires an occurrence dataset with a taxon (``tax``) and a discrete time (``bin``) columns. \n\n\n::: {.cell}\n\n```{.r .cell-code}\ndd <- divDyn(dats, tax=\"genus\", bin=\"stg\")\n```\n:::\n\n\nThe output of this function resembles that of the binstat() function. Variables are organized with their names.\n- Names starting with t- (e.g. t3) are taxon counts\n- Names starting with div- are diversity estimators.\n- Names starting with ori- and ext- are origination and extinction rate estimators, respectively.\n- Names starting with samp- are measures of sampling completeness.\nThe abbreviations are resolved in the help file that can be accessed with\n\n\n::: {.cell}\n\n```{.r .cell-code}\n?divDyn\n```\n:::\n\n\nThis file also includes all equations that are used to calculate the variables. \n\nThe most basic way to count richness over time is with range-through diversities (``divRT``). This is simply just the count of taxa that was supposed to be living in an interval (assuming presence if it was found before and after it, if it is not sampled). You can plot these with:\n\n\n::: {.cell plot='true'}\n\n```{.r .cell-code}\n# simple diversity\n  tp(ylim=c(0,300), ylab=\"richness\")\t\n  lines(stages$mid, dd$divRT, lwd=2)\n```\n\n::: {.cell-output-display}\n![](scleractinian-tutorial_chronos_files/figure-html/divRT-1.png){width=672}\n:::\n:::\n\n\nThis is the metric that can be applied to Sepkoski's compendium [@sepkoski_compendium_2002]. Note that diversity in the Cretaceous is comparable to those that corals demonstrated in the Neogene, with a slight decrease in the Cretaecous. The sharp drop in the last bin is also worthy of notion. This is an edge effect and is also partially present because the fossil information in the Holocene is usually worse in the PaleoDB. However, adding all recent taxa to the dataset would also create an artifact known as the Pull of the Recent. The complete preservation would spuriously increase range-based diversity estimates in the last few bins.\n\n## Subsampling\n\nUltimately, all time series of richness suffer from the heterogeneity of sampling in space and time, as well as a number of other factors. For instance, the temporal bias is clear, as there is a high correlation between sampling and richness through time.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncor.test(dd$divRT, bs$occs, method=\"spearman\")\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in cor.test.default(dd$divRT, bs$occs, method = \"spearman\"): Cannot\ncompute exact p-value with ties\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n\n\tSpearman's rank correlation rho\n\ndata:  dd$divRT and bs$occs\nS = 6167.7, p-value = 0.0007426\nalternative hypothesis: true rho is not equal to 0\nsample estimates:\n      rho \n0.5002229 \n```\n:::\n:::\n\n\nSubsampling aims at estimating what values the focus variables would take, if sampling were uniform over time. This methodology was developed for richness estimation (in an analytical context first, i.e. algegra and equations and then with Monte Carlo simulations), but can be generalized to other variables. You are invited to check out this generalization in the package Handout that you can access with the \n\n\n::: {.cell}\n\n```{.r .cell-code}\nvignette(\"handout\")\n```\n:::\n\ncommand.\n\n### Classical Rarefaction\n\nAs all intervals have sampling at least 50 occurrences, let's start with rarefying every stage to ``50`` occurrences. You can accomplish this by running:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncr50 <- subsample(dats, tax=\"genus\", bin=\"stg\", \n  q=50, coll=\"collection_no\", duplicates=FALSE, iter=300)\n```\n:::\n\n\nThis function call will run the default Classical Rarefaction method on every interval ``300`` times, calculate the entire divDyn output matrix in every trial and averages the results. With specifying ``coll=collection_no`` and ``duplicates=FALSE``, we instruct the function to treat the multiple occurrences of the same genus in a collection as one. It's structure is the same as that of ``divDyn()``'s, so you can access the variables the same way.\n\n\n::: {.cell plot='true'}\n\n```{.r .cell-code}\ntp(ylim=c(0,100), ylab=\"Subsampled richness\")\t\nlines(stages$mid, cr50$divRT, lwd=2)\n```\n\n::: {.cell-output-display}\n![](scleractinian-tutorial_chronos_files/figure-html/subDiv-1.png){width=672}\n:::\n:::\n\n\nThat is a different overall picture. Note the much higher peak in the Cretaceous then before.You can also note the low variation of the series. This is an artifact of using classical rarefaction on the data: as the quota drops the curces get flatter and flatter. This is the primary reason why Shareholder Quorum Subsamping was developed (Alroy, 2010). \n\n### Shareholder Quorum Subsampling (SQS)\n\nSQS is the algorithmic solution that tries to subsample the data to an equal coverage. Coverage is just frequency of the taxon of total sampling pool, which is desired to be constant in the whole series. The detailed understanding of what SQS is doing and how is unfortunately out of scope of this tutorial, but its detail scan be found in J. Alroy' paper in Science [@alroy_shifting_2010].\n\nInstead of a quota, SQS requires a quorum, a target coverage. This quorum is dependent on the taxon coverage estimation process used in the algorithm. A too high quorum will result in missing information from the time bin. You can run the basic SQS by running. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nsqsDD <- subsample(dats, tax=\"genus\", bin=\"stg\", q=0.5, type=\"sqs\",\n  duplicates=FALSE, coll=\"collection_no\", iter=300)\n```\n:::\n\n\nThen you can plot the results with.\n\n\n::: {.cell plot='true'}\n\n```{.r .cell-code}\ntp(ylim=c(0,100), ylab=\"Subsampled richness (SQS, 0.5)\")\t\nlines(stages$mid, sqsDD$divRT, lwd=2)\n```\n\n::: {.cell-output-display}\n![](scleractinian-tutorial_chronos_files/figure-html/subDivSQS-1.png){width=672}\n:::\n:::\n\n\nThis is a much more accurate depiction of diversity but we still do not know much about the diversity trajectory in the Neogene. Luckily  there are estimators that are not biased by this effects. Sampled-in-bin diversities (``divSIB``) are only influenced by sampling within the interval of focus, but they have to be corrected for sampling too. \nLuckily this is not imporant issue, as there are estimators that are not biased by this effects. Sampled-in-bin diversities (``divSIB``) are only influenced by sampling within the interval of focus, which we can also calculate with gap analysis of the record (i.e. how many taxa are sampled immediately before and after the focal interval but in it). This metric is known as the Corrected Sampled-In-Bin diversity (``divCSIB``), which is recommended for general use.\n\nThe likely trajectory of coral diveristy through time is then:\n\n\n::: {.cell plot='true'}\n\n```{.r .cell-code}\ntp(ylim=c(0,80), ylab=\"Subsampled richness (SQS, 0.5)\")\t\nlines(stages$mid, sqsDD$divCSIB, lwd=2)\n```\n\n::: {.cell-output-display}\n![](scleractinian-tutorial_chronos_files/figure-html/subCSIB-1.png){width=672}\n:::\n:::\n\n\nincludes a huge peak in the Cretaceous. \n\n## Turnover rates\n\nWe can get more information about what guided the taxon's history through time by looking at the temporal trajectories of turnover. The main ``divDyn()`` function output includes turnover these rates. You can plot the per capita extinction and origination rates of Foote [@foote_morphological_1999] with the following lines of code: \n\n\n::: {.cell plot='true'}\n\n```{.r .cell-code}\n# turnover rates\ntp(ylim=c(0,1), ylab=\"per capita turnover rates\")\t\nlines(stages$mid, dd$extPC, lwd=2, col=\"red\")\nlines(stages$mid, dd$oriPC, lwd=2, col=\"green\")\nlegend(\"topright\", legend=c(\"extinction\", \"origination\"), \n  col=c(\"red\", \"green\"), lwd=2)\n```\n\n::: {.cell-output-display}\n![](scleractinian-tutorial_chronos_files/figure-html/turn-1.png){width=672}\n:::\n:::\n\n\nNote huge peaks at the ends of the series (origination rates peak at the beginning and extinction rates at the recent end). These are edge effects that are force due to the dataset structure. You can note the effects of the end-Triassic, Pliensbachian-Toarcian and the end-Cretaceous crises on the rates. Subsampling typically has a much lower effect on turnover rates, but it is helpful to validate patterns that you see with the raw data. Although this has has to be assessed in more detail J. Alroy recommended to use Classical Rarefaction for the estimation of turnover rates. \n\n\n# Symbiotic status' effect on diversity dynamics\n\nStory gets more interesting when the difference between different symbiotic types are considered. Zooxanthellate (Z) and Azooxanthellate (AZ) corals are about equally diverse in today oceans. The two tend to differ in morphology (Z are usually colonials, while most AZ corals are solitary) and typically occupy different environments (Z corals prefer shallower reef settings, whereas AZ corals tend to occurr in deeper waters). How the distinction emerged and what the reasons for this could be is the topic of one our papers in Paleobiology [@kiessling_biodiversity_2015], where these snippets of code come from.\n\nDetermining the symbotic status (whether or not they host photosymbionts) of extant corals is straightforward, but not so for fossil ones. Although the photosymbionts do not fossilize, some morphological traits and geogchemical properties correlate with the corals' ability to host symbionts. W. Kiessling compiled a list of most likely photosymiotic status for coral genera occurring in the Paleobiology Database. This list is available from GitHub and can be loaded directly with this URL. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nsym <- fetch(dat=\"som\", \"kiessling-coralgenera\")\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nIf you use the data in publications, please cite its\nreference(s), as well as that of the 'chronosphere' package.\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nKiessling, W., & Kocsis, Á. T. (2015). Biodiversity dynamics and environmental occupancy of fossil azooxanthellate and zooxanthellate scleractinian corals. Paleobiology, 41(3), 402–414.\n```\n:::\n:::\n\n\nThis table also contains information about corallite integrity, coloniality, and whether the taxon is extant or extinct.\n\nEvery row in this table represent a coral genus in the PBDB, which is designated with in the column ``genus.subgenus``.\nThese entries were assigned to valid genus names (``genus.proper``) by Wolfgang Kiessling.\nIt is very easy to match the two tables with the ``merge()`` function. Stating ``all.x=TRUE`` forces the keeping of all rows in the first argument, which is in our case the PaleoDB. This is handy, as we'd like to assess how many fossil genera do get phototsymbiotic tags.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# merge the two tables\ndats <- merge(dats, sym, by.x=\"genus\", by.y=\"genus.subgenus\", all.x=TRUE)\n\n# which are not merged?\n# occurrences\nsum(is.na(dats$ECOLOGY))/nrow(dats) \n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 0.04595524\n```\n:::\n\n```{.r .cell-code}\n# genera\ngenTab<-unique(dats[, c(\"genus\", \"ECOLOGY\")])\nsum(is.na(genTab$ECOLOGY))/nrow(genTab) \n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 0.06451613\n```\n:::\n:::\n\n\t\nThe table also contains useful information about whether the taxa are extant or extinct. As there are some \n\nYou can calculate the diversity dynamics of these groups separately by subsetting the occurrence data to two subsets and then running the ``divDyn()`` function on them separately on them. As their ecology tend to be similar, the Azoxanthellate and Apozooxanthellate (non- and facultatively symbiotic) corals are analyzed together.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# subset\nzdat <- dats[dats$ECOLOGY==\"z\", ]\nazdat <- dats[dats$ECOLOGY==\"az\" | dats$ECOLOGY==\"ap\", ]\n\n# divDyn\nzDD <- divDyn(zdat, tax=\"genus\", bin=\"stg\")\nazDD <- divDyn(azdat, tax=\"genus\", bin=\"stg\")\t\n```\n:::\n\n\nThe difference in the diversity trajectories of the two group is striking, even with the raw patterns. You are invited to check the difference with subsampling, but as the preservation potential is similar, it is likely that subsampling won't affect relative numbers.\n\n\n::: {.cell plot='true'}\n\n```{.r .cell-code}\ntp(ylim=c(0,200), ylab=\"Raw richness\")\t\nlines(stages$mid, zDD$divRT, lwd=2, col=\"blue\")\nlines(stages$mid, azDD$divRT, lwd=2, col=\"orange\")\n\n# legend function\nlegZAZ <- function(...) \n  legend(legend=c(\"z\", \"az\"), col=c(\"blue\", \"orange\"), \n    lty=c(1,1), bg=\"white\", cex=1.3, ...)\nlegZAZ(\"topleft\")\n```\n\n::: {.cell-output-display}\n![](scleractinian-tutorial_chronos_files/figure-html/zazdiv-1.png){width=672}\n:::\n:::\n\n\nBut what about turnover? You can contrast the extinction rates of the two groups with the already calculated per-capita rates.\n\n\n\n::: {.cell plot='true'}\n\n```{.r .cell-code}\n# plot\ntp(ylim=c(0,1), ylab=\"Per capita extinctions\")\t\n# lines\nlines(stages$mid, zDD$extPC, lwd=2, col=\"blue\")\nlines(stages$mid, azDD$extPC, lwd=2, col=\"orange\")\n# legend\nlegZAZ(\"topleft\")\n```\n\n::: {.cell-output-display}\n![](scleractinian-tutorial_chronos_files/figure-html/zazext-1.png){width=672}\n:::\n:::\n\n\nOverall, the two series are quite similar. Z corals appear to be somewhat more affected at the end-Cretaceous. How about originations?\n\n\n::: {.cell plot='true'}\n\n```{.r .cell-code}\n# plot\ntp(ylim=c(0,1), ylab=\"Per capita originations\")\t\n# lines\nlines(stages$mid, zDD$oriPC, lwd=2, col=\"blue\")\nlines(stages$mid, azDD$oriPC, lwd=2, col=\"orange\")\n# legend\nlegZAZ(\"topleft\")\n```\n\n::: {.cell-output-display}\n![](scleractinian-tutorial_chronos_files/figure-html/zazori-1.png){width=672}\n:::\n:::\n\n\nBut how do we know that differences are meaningful? The difference in the rates of the two group can come from two sources: random estimation error, or group membership. Estimation error will depend on the number of sampled taxa. One way to figure this out is to use the priciniples of model selection: we can compare the likelihood support of two models: whether the observed difference comes from the estimation error of a single model or there are actually two separate models that better describe the observed patterns. This principle is implemented in the fucntion ``ratesplit()`` that compares these two models in a single call. For this, the ECOLOGY variable has to be cleaned:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nzdat$ecol <- \"z\"\nazdat$ecol <- \"az\"\n```\n:::\n\n\nThen the function can be called using the new variable:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrs<-ratesplit(rbind(zdat, azdat), sel=\"ecol\", tax=\"genus\", bin=\"stg\")\n```\n:::\n\n\nThis function compares the per capita rates that we have been working with, and the output shows the bin numbers where difference is meaningful.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrs\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n$ext\n[1] 66 94\n\n$ori\n[1] 75 81\n```\n:::\n:::\n\n\nYou can visualize these with dots. The results for origination rates indicate that azoxantellate corals showed bursts of evolution in some intervals.\n\n\n::: {.cell plot='true'}\n\n```{.r .cell-code}\ntp(ylim=c(0,1), ylab=\"Per capita originations\")\t\nlines(stages$mid, zDD$oriPC, lwd=2, col=\"blue\")\nlines(stages$mid, azDD$oriPC, lwd=2, col=\"orange\")\nlegZAZ(\"topleft\")\n\n# display selectivity with points\n# select the higher rates\nselIntervals<-cbind(zDD$oriPC[rs$ori], azDD$oriPC[rs$ori])\ngroupSelector<-apply(selIntervals, 1, function(x) x[1]<x[2])\n# draw the points\npoints(stages$mid[rs$ori[groupSelector]], azDD$oriPC[rs$ori[groupSelector]],\n  pch=16, col=\"orange\", cex=2)\npoints(stages$mid[rs$ori[!groupSelector]], zDD$oriPC[rs$ori[!groupSelector]],\n  pch=16, col=\"blue\", cex=2)\n```\n\n::: {.cell-output-display}\n![](scleractinian-tutorial_chronos_files/figure-html/zazoriSel-1.png){width=672}\n:::\n:::\n\n\nExtinction rate results are:\n\n\n\n::: {.cell plot='true'}\n\n```{.r .cell-code}\ntp(ylim=c(0,1), ylab=\"Per capita extinctions\")\t\nlines(stages$mid, zDD$extPC, lwd=2, col=\"blue\")\nlines(stages$mid, azDD$extPC, lwd=2, col=\"orange\")\nlegZAZ(\"topleft\")\n\n# display selectivity with points\n# select the higher rates\nselIntervals<-cbind(zDD$extPC[rs$ext], azDD$extPC[rs$ext])\ngroupSelector<-apply(selIntervals, 1, function(x) x[1]<x[2])\n# draw the points\npoints(stages$mid[rs$ext[groupSelector]], azDD$extPC[rs$ext[groupSelector]],\n  pch=16, col=\"orange\", cex=2)\npoints(stages$mid[rs$ext[!groupSelector]], zDD$extPC[rs$ext[!groupSelector]],\n  pch=16, col=\"blue\", cex=2)\n```\n\n::: {.cell-output-display}\n![](scleractinian-tutorial_chronos_files/figure-html/zazextSel-1.png){width=672}\n:::\n:::\n\n\nNote that despite the apparently higher extinction rates of Z corals, the difference in the end-Createcous mass extinction is not supported by the method. The end-Pleistocene value is likely a result of the data treatmen around the recent, but the observed difference in the late Jurassic was not significant in our prevoius study [@kiessling_biodiversity_2015]. This points to the importance of using clean data, and importance of the quick reproduction/reanalysis that the divDyn package now provides.\n\n\n# References\n\nAlroy, J. (2010). The Shifting Balance of Diversity Among Major Marine Animal Groups. Science, 329, 1191–1194. https://doi.org/10.1126/science.1189910\n\nFoote, M. (1999). Morphological Diversity In The Evolutionary Radiation Of Paleozoic and Post-Paleozoic Crinoids. Paleobiology, 25(S2), 1–115.\n\nKiessling, W., & Kocsis, A. T. (2015). Biodiversity dynamics and environmental occupancy of fossil azooxanthellate and zooxanthellate scleractinian corals. Paleobiology, 41(3), 402–414.\n\nSepkoski Jr, J. J. (2002). A compendium of fossil marine animal genera. Bulletins of American Paleontology, 363, 1-560.\n",
    "supporting": [
      "scleractinian-tutorial_chronos_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}